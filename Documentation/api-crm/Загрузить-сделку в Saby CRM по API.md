# Загрузить сделку в Saby CRM по API

Запрос создает сделку на основании данных из внешней системы. В результате запроса сделки из внешней системы будут перенесены в Saby CRM.

При загрузке сделки вы можете:

- проверить, какие темы отношений есть в Saby, и выбрать нужную для загрузки;
- проверить, есть ли ваш клиент в Saby и, если нет, создать его.

## Параметры запроса

Метод запроса: CRMLead.insertRecord

Адрес запроса: https://online.sbis.ru/service/

| Параметр | Тип | Описание |
|----------|-----|----------|
| Регламент* | Число целое | целочисленный идентификатор регламента |
| Ответственный | Строка | числовой идентификатор ответственного за сделку (сотрудник, подразделение, рабочая группа) или UUID-идентификатор сотрудника в сервисе профилей |
| Клиент** | Запись | данные клиента. Обязателен, если не указан параметр «КонтактноеЛицо»<br>  - @Лицо: Строка — идентификатор клиента<br>  - ИНН**: Строка — ИНН клиента. Обязателен, если не указан параметр «@Лицо»<br>  - КПП**: Строка — КПП клиента. Обязателен, если не указан параметр «@Лицо»<br>  - Наименование: Строка — название клиента<br>  - Type: Массив число целое — список типов клиентов. Возможные значения: «0» — юридическое лицо, «1» — индивидуальный предприниматель, «2» — физическое лицо |
| КонтактноеЛицо** | Запись | данные контактного лица. Обязательный, если не указан параметр «Клиент»<br>  - ФИО*: Строка — ФИО представителя клиента<br>  - Телефон**: Строка — телефон. Можно указать несколько номеров через «,». Обязателен, если не указан email<br>  - email**: Строка — адрес электронной почты. Можно указать несколько адресов через «,». Обязателен, если не указан «Телефон» |
| Примечание | Строка | примечание к сделке |
| Источник | Число целое | внешний канал, по которому создана сделка. Возможные значения |
| Notify | Логическое | признак отправки уведомлений. Значение по умолчанию — false |
| UseRules | Логическое | признак использования правил регистрации. Значение по умолчанию — true |
| UserConds | JSON-объект | условия, которые указывает пользователь для правил регистрации. Формат "название условия": "значение" |
| Nomenclatures | JSON-объект | список товаров в сделке<br>  - code*: Строка — код номенклатуры<br>  - price*: Вещественное число — цена<br>  - count*: Число целое — количество |
| ЗначенияДопПолей | JSON-объект | JSON в формате дополнительных полей |

## Результат

| Параметр | Тип | Описание |
|----------|-----|----------|
| Регламент | Число целое | идентификатор регламента |
| Ответственный | Строка | числовой идентификатор ответственного за сделку (сотрудник, подразделение, рабочая группа) или UUID-идентификатор сотрудника в сервисе профилей |
| @Документ | Число целое | идентификатор сделки в локальной схеме |
| ИдентификаторДокумента | UUID | UUID документа в ЭДО, с которым связана сделка |
| Клиент | Запись | данные о клиенте<br>  - @Лицо: Строка — идентификатор клиента<br>  - ИНН**: Строка — ИНН клиента. Параметр обязателен, если не указан параметр «@Лицо»<br>  - КПП**: Строка — КПП клиента. Параметр обязателен, если не указан параметр «@Лицо»<br>  - Наименование: Строка — название клиента |
| КонтактноеЛицо | Запись | данные о контактном лице<br>  - ФИО*: Строка — ФИО представителя клиента<br>  - Телефон**: Строка — телефон. Можно указать несколько номеров через «,». Обязателен, если не указан email<br>  - email**: Строка — адрес электронной почты. Можно указать несколько адресов через «,». Обязателен, если не указан «Телефон» |
| Примечание | Строка | примечание к сделке |
| Состояние | Строка | описание состояния записи |
| Источник | Число целое | внешний канал, по которому создана сделка |

## Примеры
## Примеры

### Загрузить сделку

```json
{
  "jsonrpc": "2.0",
  "method": "CRMLead.insertRecord",
  "params": {
    "Лид": {
      "d": {
        "Регламент": 123456,
        "КонтактноеЛицо": {
          "d": {
            "ФИО": "Иванов Иван Иванович",
            "Телефон": "111111",
            "email": "test@test.test1"
          },
          "s": {
            "ФИО": "Строка",
            "Телефон": "Строка",
            "email": "Строка"
          }
        },
        "Примечание": "Примечание к сделке",
        "UserConds": {
          "Номер формы, с которой пришли": "123",
          "Сумма в корзине": "1000"
        },
        "Nomenclatures": [
          {
            "code": "X1234567",
            "price": 1500.4,
            "count": 5
          }
        ]
      },
      "s": {
        "Регламент": "Число целое",
        "КонтактноеЛицо": "Запись",
        "Примечание": "Строка",
        "UserConds": "JSON-объект",
        "Nomenclatures": "JSON-объект"
      }
    }
  }
}
```

### Загрузить сделку без создания карточки контрагента

```javascript
requirejs(['Types/source'], function(blo) {
        new blo.SbisService({
                endpoint: {
                        contract: 'CRMLead',
                        address: '/service/?x_version=20.7202-3'
                }
        }).call(
                'insertRecord', {
                        "Лид": {
                          "d": [
                                123456,
                                {
                                  "d": [
                                        "Иванов Иван Иванович",
                                        "111111",
                                        "test@test.test1"
                                  ],
                                  "s": [
                                        {
                                          "n": "ФИО",
                                          "t": "Строка"
                                        },
                                        {
                                          "n": "Телефон",
                                          "t": "Строка"
                                        },
                                        {
                                          "n": "email",
                                          "t": "Строка"
                                        }
                                  ]
                                },
                                "Строка примечания",
                                {
                                  "Номер формы, с которой пришли": "123",
                                  "Сумма в корзине": "1000"
                                },
                                [
                                  {
                                        "code": "X1234567",
                                        "price": 1500.4,
                                        "count": 5
                                  }
                                ]
                          ],
                          "s": [
                                {
                                  "n": "Регламент",
                                  "t": "Число целое"
                                },
                                {
                                  "n": "КонтактноеЛицо",
                                  "t": "Запись"
                                },
                                {
                                  "n": "Примечание",
                                  "t": "Строка"
                                },
                                {
                                  "n": "UserConds",
                                  "t": "JSON-объект"
                                },
                                {
                                  "n": "Nomenclatures",
                                  "t": "JSON-объект"
                                }
                          ],
                          "_type": "record",
                          "f": 0
                        }
                                                }
                  ); //.addBoth(console.info);
                });
```

### Ответ

```json
{
  "jsonrpc": "2.0",
  "result": {
    "d": {
      "@Документ": 654321,
      "ИдентификаторДокумента": "17ca9bb3-d010-4cad-bfdb-c09976b1a131",
      "Регламент": 123456,
      "Клиент": null,
      "КонтактноеЛицо": {
        "d": {
          "ФИО": "Рогожин Николай Иванович",
          "Телефон": "97832678",
          "email": "create_lead@create_lead.com"
        },
        "s": {
          "ФИО": "Строка",
          "Телефон": "Строка",
          "email": "Строка"
        }
      },
      "Примечание": "Примечание к сделке",
      "Состояние": "",
      "Источник": null
    },
    "s": {
      "@Документ": "Число целое",
      "ИдентификаторДокумента": "UUID",
      "Регламент": "Число целое",
      "Клиент": "Запись",
      "КонтактноеЛицо": "Запись",
      "Примечание": "Строка",
      "Состояние": "Строка",
      "Источник": "Число целое"
    }
  },
  "id": 0,
  "protocol": 6
}
```

### Пример интеграции на python с авторизацией, поиском и созданием клиента, созданием сделки по клиенту

```python
import json
import requests


def login(user_name, pwd) -> str:
    """
    Авторизация
    """
    return invoke(
        "СБИС.Аутентифицировать",
        {"Параметр": {"Логин": user_name, "Пароль": pwd}},
        None,
    )["result"]


def invoke(method: str, params: dict, auth_sid) -> dict:
    """
    Вызов метода
    """
    payload = {
        "jsonrpc": "2.0",
        "method": method,
        "params": params,
        "protocol": 2,
        "id": 0,
    }

    headers = {
        "Host": "online.sbis.ru",
        "Content-Type": "application/json-rpc; charset=utf-8",
        "Accept": "application/json-rpc",
    }

    if auth_sid:
        headers["X-SBISSessionID"] = auth_sid
        url = "https://online.sbis.ru/service/"
    else:
        url = "https://online.sbis.ru/auth/service/"

    r = requests.post(url, headers=headers, data=json.dumps(payload))

    return json.loads(r.text)


# Аутентификация в системе СБИС
sid = login("Login", "Password")

# 1) Создать физическое лицо:
# Параметры запроса
params = {
    "CustomerData": {
        "d": {
            "Surname": "Иванов",
            "Name": "Иван",
            "Patronymic": "Иванович",
            "Gender": 0,
            "Address": "Адрес физического лица",
        },
        "s": {
            "Surname": "Строка",
            "Name": "Строка",
            "Patronymic": "Строка",
            "Gender": "Число целое",
            "Address": "Строка",
        },
    }
}
# Создание физического лица
person_id = invoke("CRMClients.SaveCustomer", params, sid)["result"]

# 2) Создать организацию:
# Параметры запроса
params = {
    "params": {
        "d": {
            "ИНН": "3664069397",
            "КПП": "444406938",
            "Название": "ООО 'Тестовая Компания'",
        },
        "s": {"ИНН": "Строка", "КПП": "Строка", "Название": "Строка"},
    }
}
# Создание организации
org_id = invoke("Контрагент.ПоИННКППКФ", params, sid)["result"]

# 3) Cоздать сделку по контрагенту:
# Получение темы отношений
theme_name = "Продажи"
theme_id = invoke("CRMLead.getCRMThemeByName", {"НаименованиеТемы": theme_name}, sid)[
    "result"
]["d"]["Регламент"]

# Параметры запроса
client_id = org_id
params = {
    "Лид": {
        "d": {
            "Регламент": theme_id,
            "Клиент": {
                        "d": {
                                "@Лицо": str(client_id),
                                "Type": [0, 2]
                        },
                        "s": {
                                "@Лицо": "Строка",
                                "Type": {"Массив": "Число целое"}
                        }
                        },
                "UserConds": {
                        "Номер формы, с которой пришли": "123",
                        "Сумма в корзине": "1000"
                },
                "Nomenclatures": [
                        {
                                "code": "X1234567",
                                "price": 1500.4,
                                "count": 5
                        }
                ]
       },
       "s": {
                "Регламент": "Число целое",
                "Клиент": "Запись",
                "UserConds": "JSON-объект",
                "Nomenclatures": "JSON-объект"
        }
}
}
# Создание сделки по контрагенту
lead_ans = invoke("CRMLead.insertRecord", params, sid)["result"]
print(lead_ans)
```